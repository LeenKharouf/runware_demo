<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Runware Demo</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      #debug {
        margin-top: 20px;
        padding: 10px;
        background: #2a2d36;
        color: #f5f6fa;
        border-radius: 6px;
        font-size: 14px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .spinner {
        margin: 20px auto;
        border: 6px solid #393b47;
        border-top: 6px solid #7c5cff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <h1>Build with Runware, in seconds</h1>
    <p>Type a prompt, then click a button to see the magic.</p>

    <div class="row">
      <input id="prompt" placeholder="e.g., a fox in watercolor" style="flex:1" />
      <button id="imgBtn">Image</button>
      <button id="vidBtn">Video</button>
      <button id="surpriseBtn">üé≤ Surprise Me</button>
    </div>

    <div id="status"></div>
    <div id="spinner" style="display:none;" class="spinner"></div>
    <div id="result"></div>
    <!-- <h3>Debug (Raw API Response)</h3> -->
    <!-- <div id="debug">Nothing yet...</div> -->

    <script>
      const promptEl = document.getElementById('prompt');
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const debugEl = document.getElementById('debug');
      const spinnerEl = document.getElementById('spinner');

      // ---------------- IMAGE GENERATION ----------------
      async function callImageApi() {
        const prompt = promptEl.value.trim();
        if (!prompt) {
          alert("Please enter a prompt!");
          return;
        }

        statusEl.textContent = "Generating image‚Ä¶ please wait ‚è≥";
        resultEl.innerHTML = "";
        spinnerEl.style.display = "block";
        // debugEl.textContent = "Waiting for response...";

        try {
          const res = await fetch("/generate-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });
        let data;
        try {
        data = await res.json();
        } catch (err) {
        statusEl.textContent = "‚ùå Failed to parse server response";
        debugEl.textContent = await res.text();
        spinnerEl.style.display = "none";
        return;
        }

        //   debugEl.textContent = JSON.stringify(data, null, 2);

          if (data.error) {
            statusEl.textContent = "Error: " + data.error;
            spinnerEl.style.display = "none";
            return;
          }

          statusEl.textContent = "Image ready ‚úÖ";
          const imageUrl = data.data?.[0]?.imageURL;
          if (imageUrl) {
            const img = document.createElement("img");
            img.src = imageUrl;
            resultEl.appendChild(img);
          } else {
            statusEl.textContent = "No image URL found ü§î";
          }
        } catch (err) {
          statusEl.textContent = "Network error ‚ùå";
          debugEl.textContent = err.toString();
        } finally {
          spinnerEl.style.display = "none";
        }
      }

      // ---------------- VIDEO GENERATION ----------------
      async function callVideoApi() {
        const prompt = promptEl.value.trim();
        if (!prompt) {
          alert("Please enter a prompt!");
          return;
        }

        statusEl.textContent = "Submitting video request‚Ä¶ üé¨";
        resultEl.innerHTML = "";
        spinnerEl.style.display = "block";
        debugEl.textContent = "Waiting for response...";

        try {
          // Step 1: start job
          const res = await fetch("/generate-video", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });
          const data = await res.json();
          debugEl.textContent = JSON.stringify(data, null, 2);

          if (data.error) {
            statusEl.textContent = "Error: " + data.error;
            spinnerEl.style.display = "none";
            return;
          }

          const taskUUID = data.data?.[0]?.taskUUID;
          if (!data.data || data.data.length === 0) {
            const msg = data.errors?.[0]?.message || "Unknown error";
            statusEl.textContent = "Video request failed ‚ùå: " + msg;
            spinnerEl.style.display = "none";
            return;
         }


          statusEl.textContent = "Video is cooking‚Ä¶ üçø (this may take 1‚Äì2 min)";

          // Step 2: Poll until ready (24 attempts = 2 minutes)
          let videoReady = false;
          for (let i = 0; i < 24; i++) {
            const check = await fetch(`/check-video/${taskUUID}`);
            const statusData = await check.json();
            // debugEl.textContent = JSON.stringify(statusData, null, 2);

            const videoUrl = statusData.data?.[0]?.videoURL;
            if (videoUrl) {
              const vid = document.createElement("video");
              vid.src = videoUrl;
              vid.controls = true;
              resultEl.appendChild(vid);

              statusEl.textContent = "Video ready ‚úÖ";
              spinnerEl.style.display = "none";
              videoReady = true;
              break;
            }

            statusEl.textContent = `Still processing ‚è≥ (attempt ${i+1}/24)‚Ä¶`;
            await new Promise(resolve => setTimeout(resolve, 5000));
          }

          if (!videoReady) {
            statusEl.textContent = "Still not ready üòÖ ‚Äî try again later with taskUUID.";
            spinnerEl.style.display = "none";
          }
        } catch (err) {
          statusEl.textContent = "Network error ‚ùå";
          debugEl.textContent = err.toString();
          spinnerEl.style.display = "none";
        }
      }

      // ---------------- BUTTON HOOKS ----------------
      document.getElementById("imgBtn").onclick = () => callImageApi();
      document.getElementById("vidBtn").onclick = () => callVideoApi();

      // ---------------- SURPRISE PROMPTS ----------------
      const surprisePrompts = [
        "A raccoon CEO giving a TED talk",
        "A robot painting a self-portrait in watercolor",
        "Shakespeare texting on an iPhone",
        "A cat DJing under neon lights",
        "A futuristic city floating in the clouds",
        "A dragon flying over Times Square",
        "A pirate ship made of candy",
        "A llama in a superhero costume"
      ];
      document.getElementById("surpriseBtn").onclick = () => {
        const randomPrompt = surprisePrompts[Math.floor(Math.random() * surprisePrompts.length)];
        promptEl.value = randomPrompt;
        statusEl.textContent = `Surprise prompt: "${randomPrompt}" üéâ`;
      };
    </script>
  </body>
</html>
